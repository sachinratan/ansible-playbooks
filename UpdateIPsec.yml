---
  - hosts: Ansi-Nodes
    user: root
    vars: 
       IPAddress: 1.1.1.1 
    tasks:

        - name: Take the existing IP address from IPsec file.
          when: inventory_hostname in ['172.31.9.88']
          shell: awk '/dxbfire-awsfrankfrt/{print;getline;print}' /etc/ipsec.conf | tail -n1 | tr -s ' ' | cut -d "=" -f2
          register: leftIP 

        - debug: var=leftIP

        - name: Replace the existing IP address in ipsec.conf file with newly updated ISP IP address on dxbfire.
          when: inventory_hostname in ['172.31.9.88']
          replace:
                path: /etc/ipsec.conf
                after: "conn dxbfire-awsfrankfrt"
                regexp: "{{ item }}"
                replace: "{{IPAddress}}"
                backup: yes
          with_items:
                - "{{ leftIP.results[0].stdout }}"

        - name: Replace the existing IP address in ipsec.secrets file with newly updated ISP IP address on dxbfire.
          when: inventory_hostname in ['172.31.9.88']
          replace:
                path: /etc/ipsec.secrets
                after: "#dxbfire-awsfrankfrt"
                regexp: "{{ item }}"
                replace: "{{IPAddress}}"
                backup: yes
          with_items:
                - "{{ leftIP.results[0].stdout }}"

        - name: Replace the existing IP address in ipsec.conf file with newly updated ISP IP address on frkfire.
          when: inventory_hostname in ['172.31.1.197']
          replace:
                path: /etc/ipsec.conf
                after: "conn dxbfire-awsfrankfrt"
                regexp: "{{ item }}"
                replace: "{{IPAddress}}"
                backup: yes
          with_items:
                - "{{ leftIP.results[0].stdout }}"

        - name: Replace the existing IP address in ipsec.secrets file with newly updated ISP IP address on frkfire.
          when: inventory_hostname in ['172.31.1.197']
          replace:
                path: /etc/ipsec.secrets
                after: "#dxbfire-awsfrankfrt"
                regexp: "{{ item }}"
                replace: "{{IPAddress}}"
                backup: yes
          with_items:
                - "{{ leftIP.results[0].stdout }}"

        - name: Replace the existing IP address in ipsec.conf file with newly updated ISP IP address on irephxfire.
          when: inventory_hostname in ['172.31.8.117']
          replace:
                path: /etc/ipsec.conf
                after: "conn awsirescanit-dxbfire"
                regexp: "{{ item }}"
                replace: "{{IPAddress}}"
                backup: yes
          with_items:
                - "{{ leftIP.results[0].stdout }}"

        - name: Replace the existing IP address in ipsec.secrets file with newly updated ISP IP address on irephxfire.
          when: inventory_hostname in ['172.31.8.117']
          replace:
                path: /etc/ipsec.secrets
                after: "##awsirescanit-dxbfire"
                regexp: "{{ item }}"
                replace: "{{IPAddress}}"
                backup: yes
          with_items:
                - "{{ leftIP.results[0].stdout }}"


        - name: Restart the ipsec service
          when: inventory_hostname in ['172.31.9.88']
          service: name=ipsec state=restarted


        - name: Up Down the tunnel on FRK firewall.
          when: inventory_hostname in ['172.31.1.197']
          shell: ipsec auto --rereadsecrets;ipsec auto --down dxbfire-awsfrankfrt; ipsec auto --delete dxbfire-awsfrankfrt; ipsec auto --add dxbfire-awsfrankfrt; ipsec auto --up dxbfire-awsfrankfrt 

        - name: Up Down the tunnel on IRE PHX firewall.
          when: inventory_hostname in ['172.31.8.117']
          shell: ipsec auto --rereadsecrets;ipsec auto --down awsirescanit-dxbfire; ipsec auto --delete awsirescanit-dxbfire; ipsec auto --add awsirescanit-dxbfire; ipsec auto --up awsirescanit-dxbfire


